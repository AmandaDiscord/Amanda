import{imageStore as t}from"./imagestore.js";import{q as e,prettySeconds as i,opcodes as s}from"./utilities.js";import{SoundCloudWrapper as a}from"./wrappers/SoundCloudWrapper.js";let serverTimeDiff=_serverTimeDiff;class ElemJS{constructor(t){t instanceof HTMLElement?this.bind(t):this.bind(document.createElement(t)),this.children=[]}bind(t){return this.element=t,this.element.js=this,this}class(){for(let t of arguments)t&&this.element.classList.add(t);return this}direct(t,e){return t&&(this.element[t]=e),this}attribute(t,e){return t&&this.element.setAttribute(t,e),this}style(t,e){return t&&(this.element.style[t]=e),this}id(t){return t&&(this.element.id=t),this}text(t){return this.element.innerText=t,this}html(t){return this.element.innerHTML=t,this}child(t,e){return"object"==typeof t&&(t.parent=this,"number"==typeof e&&e>=0?(this.element.insertBefore(t.element,this.element.children[e]),this.children.splice(e,0,t)):(this.element.appendChild(t.element),this.children.push(t))),this}clearChildren(){for(this.children.length=0;this.element.lastChild;)this.element.removeChild(this.element.lastChild)}}class AnonImage extends ElemJS{constructor(t){super("img"),this.direct("crossOrigin","anonymous"),this.direct("src",t)}}let r=/[.#]?[\w-]+/g,spaceRegex=/^\s*/;function ejs(t){let e=new Map;return t[0].split("\n").forEach(t=>{let i=t.match(spaceRegex)[0].length;t=t.replace(spaceRegex,"");let s,a;do(a=r.exec(t))&&((a=a[0]).startsWith("#")?s.id(a.slice(1)):a.startsWith(".")?s.class(a.slice(1)):s=new ElemJS(a));while(a);e.set(i,s),i>0&&e.get(i-1).child(s)}),e.get(0)}class Queue extends ElemJS{constructor(t,e){super(t),this.session=e,this.addingCount=0,this.animateMax=12,this.isFirstAdd=!0}addItem(t,e){let i=this.addingCount<this.animateMax,s=new QueueItem(t,this);i?(this.child(s,e),s.animateAdd()):setTimeout(()=>{this.child(s,e)},1300)}removeIndex(t){let e=this.children.splice(t,1)[0];e&&e.animateRemove()}removeAllTracks(){if(this.children.length<=this.animateMax){for(let t of this.children)t.animateRemove();this.children.length=0}else this.clearChildren()}shift(){let t=this.children.shift();t&&t.animateShift()}replaceItems(t){this.clearChildren(),t.forEach(t=>this.addItem(t))}}class QueueItem extends ElemJS{constructor(t,e){super("div"),this.class("queue-item"),this.queue=e,this.adding=!1,this.removing=!1,this.parts={title:ejs`div.song-title`,length:ejs`div.song-length`,controls:ejs`div.song-management`},this.data={},this.updateData(t)}updateData(t){Object.assign(this.data,t),this.render(),this.preloadThumbnail()}render(){this.clearChildren(),this.parts.title.text(this.data.title),this.parts.length.text(i(this.data.length)),this.child(this.parts.title),this.child(this.parts.length),this.child(this.parts.controls)}preloadThumbnail(){this.data.thumbnail&&this.data.thumbnail.src&&this.data.thumbnail.src.length&&t.add(this.data.thumbnail.src)}remove(){let t=this.queue.children.indexOf(this);this.disable(),this.queue.session.send({op:s.TRACK_REMOVE,d:{index:t}})}disable(){this.class("disabled"),this.parts.controls.children.forEach(t=>t.direct("onclick",null))}animateAdd(){if(this.adding)return;this.adding=!0;let t=this.queue.addingCount<this.queue.animateMax;if(t){this.queue.addingCount++;let e=window.getComputedStyle(this.element),i=["height","paddingTop","paddingBottom","marginBottom"],s={};i.forEach(t=>{s[t]="0px"}),s.opacity=0,s.marginBottom="-10px",s.easing="ease";let a={};i.forEach(t=>{a[t]=e[t]}),this.element.children[2].getBoundingClientRect().height<1&&(a.height=parseInt(a.height)+24+"px"),a.opacity=1,Object.entries(s).forEach(t=>{this.element.style[t[0]]=t[1]}),setTimeout(()=>{this.element.animate([s,a],400).addEventListener("finish",()=>{this.adding=!1,t&&this.queue.addingCount--,Object.entries(s).forEach(t=>{this.element.style[t[0]]=""})})},70*this.queue.addingCount+200*+this.queue.isFirstAdd)}else this.element.style.display="none",setTimeout(()=>{this.element.style.display=""},70*this.queue.addingCount+(200*+this.queue.isFirstAdd+400))}animateRemove(){if(this.removing)return;this.removing=!0,this.disable();let t=window.getComputedStyle(this.element),e=["height","paddingTop","paddingBottom","marginBottom"],i={};e.forEach(e=>{i[e]=t[e]}),i.easing="ease",i.opacity=1;let s={};e.forEach(t=>{s[t]="0px"}),s.opacity=0,s.marginBottom="-10px",this.element.animate([i,s],400).addEventListener("finish",()=>{this.element.remove()})}animateShift(){if(this.shifting)return;this.shifting=!0;let t=Math.floor(this.element.getBoundingClientRect().height)+20;this.queue.element.animate([{top:"0px",easing:"ease-out"},{top:-t+"px"}],400).addEventListener("finish",()=>{this.element.remove()}),this.element.animate([{opacity:1},{opacity:0}],200).addEventListener("finish",()=>{this.element.style.opacity=0})}}class AttributeButton extends ElemJS{constructor(t,e){super("img"),this.player=t,this.propertyName=e,this.direct("onclick",()=>{this.player.attributes[e]=!this.player.attributes[e],this.player.session.requestAttributesChange({[e]:this.player.attributes[e]}),this.render()}),this.render()}render(){this.direct("src",`/images/${this.propertyName}_${this.player.attributes[this.propertyName]?"active":"inactive"}.svg`)}}class Player extends ElemJS{constructor(t,e){super(t),this.session=e,this.track=null,this.thumbnailDisplayHeight=94,this.attributes={},this.trackSet=!1,this.parts={controls:ejs`div.controls`,time:new PlayerTime},["togglePlayback","skip","stop"].forEach(t=>{this.parts.controls.child(new AnonImage(`/images/${t}.svg`).direct("onclick",()=>this.session[t]()))}),this.parts.controls.child(this.parts.loopButton=new AttributeButton(this,"loop")),this.parts.controls.child(this.parts.autoButton=new AttributeButton(this,"auto")),this.render()}setTrack(t){this.trackSet=!0,this.track=t,this.render()}updateData(t){this.trackSet=!0,Object.assign(this.track,t),this.render()}updateTime(t){this.parts.time.update(t)}updateAttributes(t){this.attributes=t,this.parts.autoButton.render(),this.parts.loopButton.render()}render(){if(this.clearChildren(),this.track){let e=new ElemJS(t.get(this.track.thumbnail.src));e.element.width=this.track.thumbnail.width,e.element.height=this.track.thumbnail.height,e.element.style.width=this.track.thumbnail.width/this.track.thumbnail.height*this.thumbnailDisplayHeight+"px",this.child(ejs`div`.child(ejs`div.thumbnail`.child(e))).child(ejs`div.player-status`.child(ejs`div.song-title.one-line`.text(this.track.title)).child(this.parts.time).child(this.parts.controls))}else this.trackSet?this.child(new ElemJS("div").class("song-title","nothing-playing").text("Nothing playing")):this.child(new ElemJS("div").class("song-title","nothing-playing").text("Connecting..."))}}class PlayerTime extends ElemJS{constructor(){super("div"),this.class("progress"),this.animation=null,this.interval=null,this.state={playing:!1,trackStartTime:0,pausedAt:0,maxTime:0,live:!1},this.child(new ElemJS("div").class("progressbar")),this.child(new ElemJS("div")),this.child(new ElemJS("div")),this.render()}update(t){Object.assign(this.state,t),this.render()}getTime(){return!this.state.playing&&this.state.pausedAt?this.state.pausedAt-this.state.trackStartTime:Date.now()-this.state.trackStartTime+serverTimeDiff}getMSRemaining(){return Math.max(0,1e3*this.state.maxTime-this.getTime())}getTransform(){return 0==this.state.maxTime||this.state.live?this.state.playing?"scaleX(1)":"scaleX(0)":`scaleX(${this.getTime()/1e3/this.state.maxTime})`}render(){this.animation&&this.animation.cancel(),this.interval&&clearInterval(this.interval),this.renderCurrentTime(),this.children[2].text(this.state.live?"LIVE":i(this.state.maxTime)),this.children[0].element.style.transform=this.getTransform(),0==this.state.trackStartTime?this.children[0].element.style.transform="scaleX(0)":this.state.playing&&(this.getMSRemaining()&&(this.animation=this.children[0].element.animate([{transform:this.getTransform(),easing:"linear"},{transform:"scaleX(1)"}],this.getMSRemaining()),this.animation.addEventListener("finish",()=>{this.children[0].element.style.transform="scaleX(1)",this.interval&&clearInterval(this.interval),this.renderCurrentTime()})),this.interval=setInterval(()=>{this.renderCurrentTime()},1e3))}renderCurrentTime(){let t;(t=0==this.state.trackStartTime?0:this.getTime())<0&&(t=0),!this.state.live&&t>1e3*this.state.maxTime&&(t=1e3*this.state.maxTime),this.children[1].text(i(Math.floor(t/1e3)))}}class SideControl extends ElemJS{constructor(t,e,i){super("button"),this.disabled=!1,this.sideControls=t,this.class("control"),this.child(new ElemJS("img").class("icon").attribute("src",`/images/${i}.svg`)),this.child(new ElemJS("span").class("name").text(e))}render(){this.element.disabled=this.disabled,this.element.style.filter=`grayscale(${+this.disabled})`,this.element.style.cursor=this.disabled?"auto":"pointer"}}class AddTrackControl extends SideControl{constructor(t){super(t,"Add track","add-shaped"),this.disabled=!0}onClick(t){document.write("lol")}}class TrackInfoControl extends SideControl{constructor(t){super(t,"Track information","information-shaped")}render(){this.disabled=!0,super.render()}}class ClearQueueControl extends SideControl{constructor(t){super(t,"Clear queue","remove-shaped"),this.element.addEventListener("click",t=>this.onClick()),this.disabled=!0}onClick(){this.sideControls.session.send({op:s.CLEAR_QUEUE,d:null})}render(){this.disabled=!this.sideControls.session.state,super.render()}}class ListenInBrowserControl extends SideControl{constructor(t){super(t,"Listen in browser","headphones-shaped"),this.element.addEventListener("click",t=>this.onClick()),this.disabled=!0,this.started=!1}onClick(){if(!this.sideControls.session.state)return;let t=this.sideControls.session.state.tracks[0];this.sideControls.session.listenManager.boot(t,()=>this.sideControls.session.player.parts.time.getTime()),this.started=!0,this.render()}render(){this.disabled=!this.sideControls.session.state||this.started,super.render()}}class SideControls extends ElemJS{constructor(t,e){super(t),this.session=e,this.mainLoaded=!1,this.parts={},this.child(this.parts.listen=new ListenInBrowserControl(this)),this.child(this.parts.add=new AddTrackControl(this)),this.child(this.parts.info=new TrackInfoControl(this)),this.child(this.parts.clear=new ClearQueueControl(this)),this.partsList=Object.values(this.parts),this.render()}render(){this.mainLoaded?this.element.style.visibility="visible":this.element.style.visibility="hidden",this.partsList.forEach(t=>t.render())}}class VoiceInfo extends ElemJS{constructor(t){super(t),this.oldMembers=[],this.members=[],this.memberStore=new Map,this.render()}setMembers(t){t.forEach(t=>{this.memberStore.has(t.id)||this.memberStore.set(t.id,new VoiceMember(t))}),this.oldMembers=this.members,this.members=t.map(t=>t.id),this.members.forEach(t=>{this.oldMembers.includes(t)||(this.memberStore.get(t).isNew=!0)}),this.oldMembers.forEach(t=>{this.members.includes(t)||this.memberStore.get(t).leave().then(()=>{this.memberStore.delete(t)})}),this.render()}render(){if(this.clearChildren(),this.members.length){let t="hidden";this.memberStore.forEach(e=>{e.parts.avatar.element.complete&&(t="visible")}),this.element.style.visibility=t;let e=!1;this.memberStore.forEach(t=>{t.isNew&&t.props.isAmanda&&(e=!0,t.join(this).then(()=>{this.memberStore.forEach(t=>{t.join(this)})}))}),e||this.memberStore.forEach(t=>{t.join(this)})}else this.element.style.visibility="hidden"}}class VoiceMember extends ElemJS{constructor(t){super("div"),this.props=t,this.avatarSize=40,this.parts={avatar:this.getAvatar(),name:this.getName()},this.isNew=!1,this.leaving=!1}join(t){return this.isNew?(this.isNew=!1,this.parts.avatar.element.complete)?(this.addSelf(t),this.animateJoin(),Promise.resolve()):new Promise(e=>{this.parts.avatar.element.addEventListener("load",()=>{this.addSelf(t),this.animateJoin(),e(void 0)})}):(this.addSelf(t),Promise.resolve())}addSelf(t){t.child(this.parts.avatar,this.props.isAmanda?0:-1),t.child(this.parts.name,this.props.isAmanda?1:-1),t.element.style.visibility="visible"}leave(){return this.leaving=!0,this.animateLeave()}animateJoin(){this.parts.avatar.element.animate([{left:"-12px",filter:"brightness(2.5)",opacity:0,easing:"ease-out"},{left:"0px",filter:"brightness(1)",opacity:1}],200)}animateLeave(){return Promise.all(Object.values(this.parts).map(t=>new Promise(e=>{t.element.animate([{opacity:1},{opacity:0}],200).addEventListener("finish",()=>{t.element.remove(),e(void 0)})})))}getAvatar(){return new AnonImage(`https://cdn.discordapp.com/avatars/${this.props.id}/${this.props.avatar}${this.props.avatar.startsWith("a_")?".gif":".png"}`).class("avatar").direct("width",this.avatarSize).direct("height",this.avatarSize)}getName(){let t=new ElemJS("div").class("name");return this.props.isAmanda&&t.child(new ElemJS("img").direct("src","/images/notes.svg")),t.child(new ElemJS("span").text(this.props.tag)),t}}export{Player,PlayerTime,Queue,QueueItem,VoiceInfo,VoiceMember,SideControls};
